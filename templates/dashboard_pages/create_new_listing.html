{% extends 'base.html' %}
{% load static %}

{% block page_specific_styles %}
  <link rel="stylesheet" href="{% static 'css/uppy.min.css' %}">
  <link rel="stylesheet" href="{% static 'css/listings.css' %}">
  <link href="https://cdn.maptiler.com/maplibre-gl-js/v2.4.0/maplibre-gl.css" rel="stylesheet" />
{% endblock %}

{% block content %}
  <section class="create-listing p-3 pt-4 flex-shrink-0">
    <div class="container-fluid">
      <div class="row">

        {% include 'includes/profile_sidebar.html' %}

        <div class="col-10 main-area">
          <div class="creation-steps d-flex justify-content-center mb-3">
            <div id="tab1" class="col shadow-sm active" onclick="changeActive(1)">1. Opis</div>
            <div id="tab2" class="col shadow-sm" onclick="changeActive(2)">2. Multimedija</div>
            <div id="tab3" class="col shadow-sm" onclick="changeActive(3)">3. Lokacija</div>
            <div id="tab4" class="col shadow-sm" onclick="changeActive(4)">4. Karakteristike</div>
            <div id="tab5" class="col shadow-sm" onclick="changeActive(5)">5. Detalji</div>
          </div>

          <form id="create-listing-form" class="needs-validation" method="POST" action="{% url 'listing_submit' %}" novalidate>
            {% csrf_token %}
            <div class="creation-content justify-content-center show" id="step1">
              <div class="col creation-step me-4">
                <div class="step-section mb-4">
                  {# Step main heading #}
                  <div class="d-flex justify-content-start mb-4 step-heading">
                    <h5 class="align-self-end me-4">Opis</h5>
                    <small class="align-self-end">Opišite vašu nekretninu</small>
                  </div>
                  <div class="mb-3">
                    <label for="title" class="form-label">Naslov oglasa (obavezno)</label>
                    <input type="text" class="form-control" id="title" name="title" aria-describedby="titleHelp" required>
                  </div>
                  <div class="mb-3">
                    <div class="d-flex justify-content-start mb-4 step-heading">
                      <p class="align-self-end me-4">Opis</p>
                      <small class="align-self-end">Napišite par rečenica o vašoj nekretnini</small>
                    </div>
                    <textarea class="form-control" name="description" id="description" cols="30" rows="16" required></textarea>
                  </div>
                </div>
              </div>

              <div class="col">
                <div class="creation-step mb-4">
                  <div class="step-section mb-4">
                    <div class="d-flex justify-content-start mb-4 step-heading">
                    <h5 class="align-self-end me-4">Status</h5>
                    <small class="align-self-end">Izaberite vrstu oglašavanja</small>
                  </div>
                  <div class="mb-3">
                    <select class="form-select" aria-label="Default select example" name="status" id="status" onchange="getDetails()">
                      <option value="0" selected>Prodaja</option>
                      <option value="1">Izdavanje</option>
                    </select>
                  </div>
                  </div>
                </div>

                <div class="creation-step mb-4">
                  <div class="step-section ">
                    <div class="d-flex justify-content-start mb-4 step-heading">
                      <h5 class="align-self-end me-4">Tip</h5>
                      <small class="align-self-end">Izaberite kategoriju i tip vaše nekretnine </small>
                    </div>
                    <div class="d-flex justify-content-between">
                      <div style="width: 280px;">
                        <label for="category" class="form-label">Kategorija</label>
                        <select class="form-select" id="category" required onchange="populateSubCategories(this);">
                          <option value="">Izaberite kategoriju</option>
                          {% for categ in categories %}
                            {% if categ.parent is None %}
                              <option value="{{ categ.id }}">{{ categ.name }}</option>
                            {% endif %}
                          {% endfor %}
                        </select>
                      </div>
                      <div style="width: 220px;">
                        <label for="tip" class="form-label">Tip</label>
                        <select required class="form-select" id="subcateg" name="subcateg" onchange="getDetails(); selectCategory()">
                        </select>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="creation-step">
                  <div class="step-section">
                    <div class="d-flex justify-content-start mb-4 step-heading">
                      <h5 class="align-self-end me-4">Cena</h5>
                      <small class="align-self-end">Upišite cenu vaše nekretnine u EUR</small>
                    </div>
                    <div class="w100">
                      <input type="text" class="form-control" id="price" name="price" required>
                    </div>
                  </div>
                </div>

                <div class="d-flex justify-content-end next-step">
                  <button class="btn btn-blue btn-creation-step" type="button" id="nextStep" onclick="switchStep(1, 2)">
                    Dalje
                    <i class="bi bi-chevron-double-right"></i>
                  </button>
                </div>
              </div>
            </div>

            <div class="creation-content justify-content-center" id="step2">
              <div class="col me-4">
                <div class="creation-step step-section mb-4">
                  {# Step main heading #}
                  <div class="text-center mb-4 step-heading">
                    <h5>Učitajte slike</h5>
                    {#                    <div id="drag-drop-area"></div>#}
                  </div>
                  <div id="browse-images"></div>
                </div>

                <div class="creation-step step-section mb-4">
                  {# Step main heading #}
                  <div class="text-center mb-4 step-heading">
                    <h5>Učitajte tlocrt</h5>
                  </div>
                  <div id="tlocrt-area"></div>
                </div>
              </div>

              <div class="col">
                <div class="creation-step step-section mb-4">
                  {# Step main heading #}
                  <div class="text-center mb-4 step-heading">
                    <h5>Učitajte video</h5>
                  </div>
                  <div id="video-area"></div>
                </div>

                <div class="creation-step step-section mb-4">
                  {# Step main heading #}
                  <div class="text-center mb-4 step-heading">
                    <h5>Učitajte virtuelnu turu</h5>
                    <div>
                      Image loader
                    </div>
                  </div>
                </div>

                <div class="d-flex justify-content-end next-step">
                  <button class="btn btn-blue btn-creation-step" type="button" id="nextStep" onclick="switchStep(2, 3)">
                    Dalje
                    <i class="bi bi-chevron-double-right"></i>
                  </button>
                </div>
              </div>
            </div>
            <div class="row creation-content justify-content-center" id="step3">
              <div class="col-6">
                <div class="creation-step step-section mb-4">
                  <div class="mb-4 step-heading">
                    <h5  class="mb-2">Lokacija</h5>
                    <small>Unesite informacije o lokaciji vaše nekretnine</small>
                  </div>
                  <div class="location-input">
                    <label for="country" class="form-label">Država (obavezno)</label>
                    <select class="form-select" id="country" name="country">
                      <option selected value="srbija">Srbija</option>
                    </select>
                  </div>
                  <div class="location-input">
                    <label for="city" class="form-label">Grad (obavezno)</label>
                    <input type="text" class="form-control" id="city" name="city" aria-describedby="titleHelp" required>
                  </div>
                  <div class="location-input">
                    <label for="municipality" class="form-label">Opština (obavezno)</label>
                    <input type="text" class="form-control" id="municipality" name="municipality"
                           aria-describedby="titleHelp" required>
                  </div>
                  <div class="location-input">
                    <label for="area" class="form-label">Lokacija (obavezno)</label>
                    <input type="text" class="form-control" id="area" name="area" aria-describedby="titleHelp" required>
                  </div>
                  <div class="location-input">
                    <label for="street" class="form-label">Ulica (obavezno)</label>
                    <input type="text" class="form-control" id="street" name="street" aria-describedby="titleHelp" required>
                  </div>
                </div>
              </div>

              <div class="col-6 d-flex flex-column">
                <div class="mb-4 step-heading">
                  <h5 class="mb-2">Postavite pin na mapu</h5>
                  <small>Postavite pin što preciznije možete kako biste bolje odredili lokaciju vaše nekretnine</small>
                </div>
                <div class="creation-step step-section h-100">
                  <div class="map-canvas h-100 " id="map"></div>
                  <input type="hidden" id="lat" name="lat" required>
                  <input type="hidden" id="lng" name="lng" required>
                  <input type="hidden" id="zoom" name="zoom" required>
                </div>

                <div class="d-flex justify-content-end mt-3 next-step">
                  <button class="btn btn-blue btn-creation-step" type="button" id="nextStep" onclick="switchStep(3, 4)">
                    Dalje
                    <i class="bi bi-chevron-double-right"></i>
                  </button>
                </div>
              </div>
            </div>

            <div class="creation-content" id="step4">
              <div class="col flex-grow-1">
                <div class="creation-step step-section mb-4">
                  <div class="mb-4 d-flex step-heading justify-content-start">
                    <h5 class="mb-2 flex-grow-1">
                      Karakteristike
                    </h5>
                    <a href="#" class="text-dark" data-bs-toggle="popover" data-bs-title="Smernice" data-bs-content="Primer ispod je za dvoiposoban stan od 80kvadrata, sa 1 kupatilom i jednim toaletom, 2 spavaće sobe i jednim garažnim mestom u zajedničkoj garaži zgrade.">
                        Potrebna pomoć?
                        <i class="bi bi-info-circle-fill"></i>
                      </a>
                  </div>
                  <div class="container-fluid">
                    <div class="row">
                      <div class="col-3 col-lg-3">
                        <div class="mb-3">
                          <label for="size" class="form-label">Površina (obavezno)</label>
                          <input type="text" class="form-control" id="size" name="size" aria-describedby="titleHelp" placeholder="npr 80" required>
                        </div>
                        <div class="mb-3">
                          <label for="structure" class="form-label">Struktura (brojevima)</label>
                          <input type="text" class="form-control" id="structure" name="structure" aria-describedby="titleHelp" placeholder="npr 2.5">
                        </div>
                        <div class="mb-3">
                          <label for="year_built" class="form-label">Godina Izgradnje</label>
                          <input type="text" class="form-control" id="year_built" name="year_built" aria-describedby="titleHelp" placeholder="npr 1983">
                        </div>
                        <div class="mb-3">
                          <label for="floor" class="form-label">Sprat</label>
                          <input type="text" class="form-control" id="floor" name="floor" aria-describedby="titleHelp" placeholder="npr 2">
                        </div>
                        <div class="mb-3">
                          <label for="total_floors" class="form-label">Od Spratova</label>
                          <input type="text" class="form-control" id="total_floors" name="total_floors" aria-describedby="titleHelp" placeholder="5">
                        </div>
                      </div>
                      <div class="col-3 col-lg-3">
                        <div class="mb-3">
                          <label for="bedrooms" class="form-label">Spavaćih soba (brojevima)</label>
                          <input type="text" class="form-control" id="bedrooms" name="bedrooms" aria-describedby="titleHelp" placeholder="npr 2">
                        </div>
                        <div class="mb-3">
                          <label for="baths" class="form-label">Kupatila (brojevima)</label>
                          <input type="text" class="form-control" id="baths" name="baths" aria-describedby="titleHelp" placeholder="npr 1">
                        </div>
                        <div class="mb-3">
                          <label for="half_baths" class="form-label">Toaleta (brojevima)</label>
                          <input type="text" class="form-control" id="half_baths" name="half_baths" aria-describedby="titleHelp" placeholder="npr 0">
                        </div>

                        <div class="mb-3" id='parcel-input'>
                          <label for="parcel_size" class="form-label">Površina parcele (u kvm)</label>
                          <input type="text" class="form-control" id="parcel_size" name="parcel_size" aria-describedby="titleHelp" placeholder="npr 30.000 za 30ari">
                        </div>
                        
                        <div class="mb-3">
                          <label for="additional" class="form-label">Ostalo/dodatno</label>
                          <input type="text" class="form-control" id="additional" name="additional" aria-describedby="titleHelp">
                        </div>
                      </div>
                      <div class="col-3 col-lg-3">
                        <div class="mb-3">
                          <label for="parking" class="form-label">Parking (izaberite vrstu)</label>
                          <select class="form-select" aria-label="Default select example" id="parking" name="parking">
                            <option value="">Izaberite...</option>
                            <option value="garaža">Garaža</option>
                            <option value="parking mesto">Parking mesto</option>
                            <option value="parking klackalica">Parking klackalica</option>
                            <option value="parking van zone">Parking van zone</option>
                            <option value="parking u zoni">Parking u zoni</option>
                            <option value="garažno mesto">Garažno mesto</option>
                            <option value="parking platforma">Parking platforma</option>
                          </select>
                        </div>
                        <div class="mb-3">
                          <label for="parking_slots" class="form-label">Parking mesta (brojevima)</label>
                          <input type="text" class="form-control" id="parking_slots" name="parking_slots" aria-describedby="titleHelp">
                        </div>
                        <div class="mb-3">
                          <label for="balcony" class="form-label">Terasa (brojevima)</label>
                          <input type="text" class="form-control" id="balcony" name="balcony" aria-describedby="titleHelp">
                        </div>
                        <div class="mb-3">
                          <label for="basement" class="form-label">Podrum</label>
                          <select class="form-select" aria-label="Default select example" id="basement" name="basement">
                            <option value="false" selected>Nema</option>
                            <option value="true">Ima</option>
                          </select>
                        </div>
                        <div class="mb-3">
                          <label for="storage" class="form-label">Ostava</label>
                          <select class="form-select" aria-label="Default select example" id="storage" name="storage">
                            <option value="false" selected>Nema</option>
                            <option value="true">Ima</option>
                          </select>
                        </div>
                      </div>
                      <div class="col-3 col-lg-3">
                        <div class="mb-3">
                          <label for="legal_status" class="form-label">Katastarski status</label>
                          <select class="form-select" aria-label="Default select example" id="legal_status" name="legal_status">
                            <option value="uknjizeno" selected>Uknjizeno</option>
                            <option value="legalizacija">Legalizacija u toku</option>
                            <option value="izgradnja" selected>U izgradnji</option>
                            <option value="neuknjizeno">Neuknjizeno</option>
                          </select>
                        </div>
                        <div class="mb-3">
                          <label for="condition" class="form-label">Stanje</label>
                          <select class="form-select" aria-label="Default select example" id="condition" name="condition">
                            <option value="novogradnja" selected>Novogradnja</option>
                            <option value="renovirano">Renovirano</option>
                            <option value="izvorno">Izvorno</option>
                          </select>
                        </div>
                        <div class="mb-3">
                          <label for="efficiency" class="form-label">Energetski pasoš</label>
                          <select class="form-select" aria-label="Default select example" id="efficiency" name="efficiency">
                            <option value="1" selected>Prodaja</option>
                            <option value="2">Two</option>
                            <option value="3">Three</option>
                          </select>
                        </div>
                        <div class="mb-3">
                          <label for="efficiency_index" class="form-label">Indeks u kWh/m2a (izaberite)</label>
                          <select class="form-select" aria-label="Default select example" id="efficiency_index" name="efficiency_index">
                            <option value="1" selected>Prodaja</option>
                            <option value="2">Two</option>
                            <option value="3">Three</option>
                          </select>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="d-flex justify-content-end next-step">
                  <button class="btn btn-blue btn-creation-step" type="button" id="nextStep" onclick="switchStep(4, 5)">
                    Dalje
                    <i class="bi bi-chevron-double-right"></i>
                  </button>
                </div>
              </div>
            </div>

            <div class="creation-content" id="step5">
              <div class="col flex-grow-1">
                <div class="creation-step step-section mb-4">
                  <div class="mb-4 step-heading">
                    <h5 class="mb-2">Detalji</h5>
                    <small>Čekirajte kvadratiće oglasa za prodaju</small>
                  </div>
                  <div class="container-fluid">
                  <div class="row" id="details">
                    
                  </div>
                  <div class="row" id="amenities">
                    
                  </div>
                  </div>
                </div>
              <div class="d-flex justify-content-end next-step">
                <button class="btn btn-blue btn-creation-step" type="submit" id="nextStep">
                  Sačuvaj
                  <i class="bi bi-chevron-double-right"></i>
                </button>
              </div>
              </div>
              <input type="hidden" id="video" name="video">
              <input type="hidden" id="tlocrt" name="tlocrt">
            </div>
          </form>
        </div>
      </div>
    </div>
  </section>
{% endblock %}

{% block page_specific_scripts %}
  <script src="{% static 'js/uppy.min.js' %}"></script>
  <script src="{% static 'js/uppy-rs.min.js' %}"></script>
  <script src="https://cdn.maptiler.com/maplibre-gl-js/v2.4.0/maplibre-gl.js"></script>


  <script>
    const popoverTriggerList = document.querySelectorAll('[data-bs-toggle="popover"]')
    const popoverList = [...popoverTriggerList].map(popoverTriggerEl => new bootstrap.Popover(popoverTriggerEl))

    function switchStep(currentStep, nextStep) {
      if (currentStep) {
        document.querySelector(`#step${currentStep}`).classList.remove('show')
        document.querySelector(`#tab${currentStep}`).classList.remove('active')
      }
      document.querySelector(`#step${nextStep}`).classList.add('show')
      document.querySelector(`#tab${nextStep}`).classList.add('active')

      if (nextStep === 2) {
        document.querySelector('.footer').classList.remove('sticky');
      } else {
        document.querySelector('.footer').classList.add('sticky');
      }
    }

    function changeActive(step) {
      const tabs = document.querySelectorAll('.creation-steps > .col')
      tabs.forEach((tab => {
        tab.classList.remove('active');
      }))
      const steps = document.querySelectorAll('.creation-content')
      steps.forEach((step => {
        step.classList.remove('show');
      }))
      switchStep(null, step);
    }

    function uploadFiles(type, result) {
      for (const item of result.successful) {
        let elem = document.createElement("input");
        elem.setAttribute("type", "hidden");
        elem.setAttribute("name", type);
        elem.setAttribute("value", item.response.body.id);
        document.querySelector('#create-listing-form').appendChild(elem);
      }
    }
    const csrfToken = document.querySelector('[name="csrfmiddlewaretoken"]').value;

    const uppy = new Uppy.Uppy({
      debug: true,
      locale: Uppy.locales.sr_RS_Latin,
      restrictions: {
        maxFiles: 5,
        maxFileSize: 1000000,
        minFileSize: 50000,
        minNumberOfFiles: 1,
        allowedFileTypes: ['image/*'],
      },
    });
    uppy.use(Uppy.Dashboard, {
      inline: true,
      width: '100%',
      height: 450,
      target: '#browse-images',
      closeAfterFinish: false,
      note: 'Slike su jedino dozvoljene, do 5 slika, do 1MB svaka',
    });
    uppy.use(Uppy.ImageEditor, {
      target: Uppy.Dashboard,
      quality: 0.8,
    });
    uppy.use(Uppy.XHRUpload, {
      endpoint: '/files/upload/',
      method: 'POST',
      formData: true,
      fieldName: 'file',
      headers: {
        'X-CSRFToken': csrfToken
      }
    });
    uppy.on('complete', (result) => {
      console.log(result);
      console.log('Upload complete! We’ve uploaded these files:', result.successful);
      uploadFiles('images[]', result);
    });

    const uppyTlocrt = new Uppy.Uppy({
      debug: true,
      locale: Uppy.locales.sr_RS_Latin,
      restrictions: {
        maxFiles: 1,
        maxFileSize: 1000000,
        minFileSize: 50000,
        minNumberOfFiles: 1,
        allowedFileTypes: ['image/*'],
      },
    });
    uppyTlocrt.use(Uppy.Dashboard, {
      width: '100%',
      height: 450,
      inline: true,
      target: '#tlocrt-area',
      closeAfterFinish: false,
      note: 'Slike su jedino dozvoljene, 1 fajl, do 1MB veličine',
    });
    uppyTlocrt.use(Uppy.XHRUpload, {
      endpoint: '/files/upload/',
      method: 'POST',
      formData: true,
      fieldName: 'file',
      headers: {
        'X-CSRFToken': csrfToken
      }
    });
    uppyTlocrt.on('complete', (result) => {
      console.log('Upload complete! We’ve uploaded these files:', result.successful);
      for (const item of result.successful) {
        document.querySelector('#tlocrt').value = item.response.body.id;
      }
    });

    const uppyVideo = new Uppy.Uppy({
      debug: true,
      locale: Uppy.locales.sr_RS_Latin,
      restrictions: {
        maxFiles: 1,
        maxFileSize: 6000000,
        minFileSize: 50000,
        minNumberOfFiles: 1,
        allowedFileTypes: ['video/*'],
      },
    });
    uppyVideo.use(Uppy.Dashboard, {
      width: '100%',
      height: 450,
      inline: true,
      target: '#video-area',
      closeAfterFinish: false,
      note: 'Video fajlovi su jedino dozvoljeni, 1 fajl, do 5MB veličine',
    });
    uppyVideo.use(Uppy.XHRUpload, {
      endpoint: '/files/upload/',
      method: 'POST',
      formData: true,
      fieldName: 'file',
      headers: {
        'X-CSRFToken': csrfToken
      }
    });
    uppyVideo.on('complete', (result) => {
      console.log('Upload complete! We’ve uploaded these files:', result.successful);
      for (const item of result.successful) {
        document.querySelector('#video').value = item.response.body.id;
      }
    });
  </script>
  <script>
function initMap() {
  const key = 'VmRKj3ewutGzwLJmPdKS';
  const style = `https://api.maptiler.com/maps/streets-v2/style.json?key=${key}`
  const belgrade = { lat: 44.8125, lng: 20.4612 };
  const map = new maplibregl.Map({
  container: 'map',
  style: style ,
  center: belgrade,
  zoom: 12
})
const marker = new maplibregl.Marker({
  color: "red",
})
function add_marker (event) {
  let coordinates = event.lngLat;
    marker.setLngLat(coordinates).addTo(map);
  document.getElementById('lng').value = coordinates.lng;
  document.getElementById('lat').value = coordinates.lat;
  document.getElementById('zoom').value = map.getZoom()
}
  map.addControl(new maplibregl.NavigationControl(), 'top-right');
  map.on('click', add_marker);
  map.on('error', function(err) {
  throw new Error("To load the map, you must replace YOUR_MAPTILER_API_KEY_HERE first, see README");
  });
}

initMap()
 

async function populateSubCategories(data) {
  try {
    const category = data.value;
    const response = await fetch(`/oglasi/get-subcategories?category=${category}`);
    const json = await response.json();
    const subcategorySelect = document.getElementById('subcateg');
    subcategorySelect.innerHTML = `<option value="0">Izaberite tip</option>`;

    json.forEach(subCat => {
      const option = document.createElement("option");
      option.value = subCat.id;
      option.text = subCat.name;
      subcategorySelect.appendChild(option);
    })

    getDetails();
  } catch (error) {
    console.error(error);
  }
  
}


    
function selectCategory() {
  const subCatValue = document.getElementById('subcateg').value
  if (subCatValue == 4 || subCatValue == 6 || subCatValue == 8 ) {
    document.getElementById('parcel-input').style.display = 'none'
  } else {
    document.getElementById('parcel-input').style.display = 'block'
  }
}
  


// Get corresponding details and amenities based on selected category and status
async function getDetails() {
  const subcategorySelect = document.getElementById('subcateg').value;
  const status = document.getElementById('status').value;

  const response = await fetch(`/oglasi/get-details?category=${subcategorySelect}&status=${status}`);
  const data = await response.json();

  const detailsDiv = document.getElementById('details');
  const amenitiesDiv = document.getElementById('amenities');

  detailsDiv.innerHTML = "";
  amenitiesDiv.innerHTML = "";

  data.details.forEach(detail => {
    detailsDiv.innerHTML += `<div class="col-lg-3 col-md-4 col-sm-12">
        <div class="form-check form-check-inline mb-2">
          <input type="checkbox" class="form-check-input" id="detail-data${detail.detail__id}" name="details_data" value="${detail.detail__id}">
          <label class="form-check-label" for="detail-data${detail.detail__id}">${detail.detail__name}</label>
        </div>
      </div>`
  })

  data.amenities.forEach(amenity => {
    amenitiesDiv.innerHTML += `<div class="col-lg-3 col-md-4 col-sm-12">
        <div class="form-check form-check-inline mb-2">
          <input type="checkbox" class="form-check-input" id="amenity-data${amenity.amenity__id}" name="amenities_data" value="${amenity.amenity__id}">
          <label class="form-check-label" for="amenity-data${amenity.amenity__id}">${amenity.amenity__name}</label>
        </div>
      </div>`
  })
}
  </script>
{% endblock %}
